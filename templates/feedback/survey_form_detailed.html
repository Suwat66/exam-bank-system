{% extends "base.html" %}
{% block title %}แบบประเมินความพึงพอใจ{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">แบบประเมินความพึงพอใจต่อการใช้งานระบบคลังข้อสอบ</h1>
        <p class="text-gray-600 mb-8">ข้อมูลของท่านจะถูกเก็บเป็นความลับและใช้เพื่อการศึกษาเท่านั้น</p>
    </div>

    <form method="post" class="bg-white p-8 rounded-lg shadow-md space-y-8">
        {% csrf_token %}

        <!-- ส่วนที่ 1: ข้อมูลทั่วไป -->
        <fieldset class="space-y-6">
            <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-6">ส่วนที่ 1: ข้อมูลทั่วไปของผู้ตอบแบบประเมิน</legend>
            
            {% if form.non_field_errors %}
                <div class="p-4 text-sm text-red-700 bg-red-100 rounded-lg">{{ form.non_field_errors }}</div>
            {% endif %}

            <div>
                <label for="{{ form.school_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.school_name.label }}</label>
                {{ form.school_name }}
                {{ form.school_name.errors }}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label for="{{ form.learning_area.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.learning_area.label }}</label>
                    {{ form.learning_area }}
                    {{ form.learning_area.errors }}
                </div>
                <div>
                    <p class="block text-sm font-medium text-gray-700">{{ form.teaching_level.label }}</p>
                    <div class="flex space-x-6 mt-2">
                        {% for radio in form.teaching_level %}
                        <label class="inline-flex items-center"><span class="mr-2">{{ radio.tag }}</span> {{ radio.choice_label }}</label>
                        {% endfor %}
                    </div>
                     {{ form.teaching_level.errors }}
                </div>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <p class="block text-sm font-medium text-gray-700">{{ form.teaching_experience.label }}</p>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 mt-2">
                        {% for radio in form.teaching_experience %}<label class="inline-flex items-center"><span class="mr-2">{{ radio.tag }}</span> {{ radio.choice_label }}</label>{% endfor %}
                    </div>
                    {{ form.teaching_experience.errors }}
                </div>
                <div>
                    <p class="block text-sm font-medium text-gray-700">{{ form.usage_duration.label }}</p>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        {% for radio in form.usage_duration %}<label class="inline-flex items-center"><span class="mr-2">{{ radio.tag }}</span> {{ radio.choice_label }}</label>{% endfor %}
                    </div>
                     {{ form.usage_duration.errors }}
                </div>
            </div>
        </fieldset>

        <!-- ส่วนที่ 2: ระดับความพึงพอใจ -->
        <fieldset class="mt-10">
            <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-6">ส่วนที่ 2: ระดับความพึงพอใจต่อการใช้งานระบบ</legend>
            
            <!-- Hidden container for all rating radio fields to be rendered by Django -->
            <div id="hidden-rating-fields" style="display: none;">
                {% for field in form %}
                    {% if field.name|slice:":7" == "rating_" %}
                        {{ field }}
                    {% endif %}
                {% endfor %}
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายการประเมิน</th>
                            <th class="w-20 text-center text-xs font-medium">5 (มากที่สุด)</th>
                            <th class="w-20 text-center text-xs font-medium">4 (มาก)</th>
                            <th class="w-20 text-center text-xs font-medium">3 (ปานกลาง)</th>
                            <th class="w-20 text-center text-xs font-medium">2 (น้อย)</th>
                            <th class="w-20 text-center text-xs font-medium">1 (น้อยที่สุด)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for category, questions in survey_questions.items %}
                        <tr class="bg-gray-100"><td colspan="6" class="px-4 py-2 font-bold text-gray-700">{{ category }}</td></tr>
                        {% for code, question_text in questions %}
                            <tr data-rating-row="{{ code }}">
                                <td class="px-4 py-3">{{ code }} {{ question_text }}</td>
                                <!-- Empty cells to be populated by JavaScript -->
                                <td class="w-20 text-center align-middle"></td>
                                <td class="w-20 text-center align-middle"></td>
                                <td class="w-20 text-center align-middle"></td>
                                <td class="w-20 text-center align-middle"></td>
                                <td class="w-20 text-center align-middle"></td>
                            </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </fieldset>

        <!-- ส่วนที่ 3: ข้อเสนอแนะ -->
        <fieldset class="mt-10 space-y-6">
            <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-6">ส่วนที่ 3: ข้อเสนอแนะเพิ่มเติม</legend>
             <div>
                <label for="{{ form.suggestion_likes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">1. {{ form.suggestion_likes.label }}</label>
                {{ form.suggestion_likes }}
            </div>
            <div>
                <label for="{{ form.suggestion_improvements.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">2. {{ form.suggestion_improvements.label }}</label>
                {{ form.suggestion_improvements }}
            </div>
            <div>
                <label for="{{ form.suggestion_future.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">3. {{ form.suggestion_future.label }}</label>
                {{ form.suggestion_future }}
            </div>
        </fieldset>

        <div class="mt-8">
            <button type="submit" class="w-full px-6 py-3 text-white bg-blue-600 rounded-md hover:bg-blue-700 font-semibold">ส่งแบบประเมิน</button>
        </div>
    </form>
</div>

<!-- JavaScript to restructure and place the radio buttons -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const hiddenContainer = document.getElementById('hidden-rating-fields');

    // Loop through each table row that needs radio buttons
    document.querySelectorAll('tr[data-rating-row]').forEach(row => {
        const questionCode = row.dataset.ratingRow;
        const fieldName = `rating_${questionCode}`;
        
        // Find all radio INPUTS for the current question within the hidden container
        const radioInputs = hiddenContainer.querySelectorAll(`input[name="${fieldName}"]`);
        
        // Find all target table cells in the current row
        const targetCells = row.querySelectorAll('td:not(:first-child)');
        
        if (radioInputs.length > 0 && targetCells.length > 0) {
            // Move each radio button to the correct cell.
            // Our form choices are defined as [5, 4, 3, 2, 1] in forms.py
            // and the table cells are also visually in that order.
            radioInputs.forEach((radio, index) => {
                if (targetCells[index]) {
                    // Add some styling to the radio button
                    radio.classList.add('h-4', 'w-4', 'text-blue-600', 'focus:ring-blue-500', 'border-gray-300');
                    targetCells[index].appendChild(radio);
                }
            });
        }
    });

    // We can now safely remove the container we used for initial rendering
    if (hiddenContainer) {
        hiddenContainer.remove();
    }
});
</script>

{% endblock %}