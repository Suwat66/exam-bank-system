{% extends "base.html" %}
{% block title %}สร้างชุดข้อสอบอัตโนมัติ{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">สร้างชุดข้อสอบอัตโนมัติ</h1>
    <p class="text-gray-600 mb-8">ระบบจะทำการสุ่มคำถามจากคลังข้อสอบของคุณตามเงื่อนไขที่กำหนด</p>

    <form method="post" id="exam-form" class="bg-white p-8 rounded-lg shadow-lg">
        {% csrf_token %}

        {% if error %}
            <div class="p-4 mb-6 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">{{ error }}</div>
        {% endif %}

        <div class.space-y-8">
            <!-- Step 1 & 2: Exam Info -->
            <fieldset class="space-y-6">
                <legend class="text-xl font-semibold text-gray-800 border-b pb-3 mb-6">ข้อมูลชุดข้อสอบ</legend>
                <div>
                    <label for="{{ form.exam_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.exam_name.label }}</label>
                    {{ form.exam_name }}
                    {{ form.exam_name.errors }}
                </div>
                <div>
                    <label for="{{ form.course.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.course.label }}</label>
                    {{ form.course }}
                    {{ form.course.errors }}
                </div>
            </fieldset>

            <!-- Step 3: Question Criteria -->
            <fieldset class="mt-10">
                <legend class="text-xl font-semibold text-gray-800 border-b pb-3 mb-6">กำหนดจำนวนข้อสอบ</legend>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">3. เลือกหน่วยการเรียนรู้ (ต้องเลือกอย่างน้อย 1 หน่วย)</label>
                        <div id="learning-units-container" class="mt-2 p-4 border border-gray-300 rounded-md bg-gray-50 min-h-[120px] max-h-48 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <p class="text-gray-500 col-span-full">โปรดเลือกรายวิชาก่อน</p>
                        </div>
                        {# This field is hidden but is required for form validation #}
                        <div class="hidden">{{ form.learning_units }}</div> 
                        {{ form.learning_units.errors }}
                    </div>

                    <div>
                        <p class="block text-sm font-medium text-gray-700 mb-2">4. ระบุจำนวนข้อในแต่ละระดับความยาก</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div>
                                <label for="{{ form.num_easy.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ form.num_easy.label }}</label>
                                {{ form.num_easy }}
                            </div>
                            <div>
                                <label for="{{ form.num_medium.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ form.num_medium.label }}</label>
                                {{ form.num_medium }}
                            </div>
                            <div>
                                <label for="{{ form.num_hard.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ form.num_hard.label }}</label>
                                {{ form.num_hard }}
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end space-x-4 mt-8 border-t pt-6">
            <a href="{% url 'teacher_dashboard' %}" class="px-6 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">ยกเลิก</a>
            <button type="submit" class="px-6 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">สร้างชุดข้อสอบ</button>
        </div>
    </form>
</div>

<!-- JavaScript for Dynamic Learning Units -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const courseSelect = document.getElementById('id_course');
    const unitsContainer = document.getElementById('learning-units-container');
    const hiddenUnitsField = document.getElementById('id_learning_units');
    const apiUrl = "{% url 'api_get_learning_units' %}";

    function fetchLearningUnits() {
        const courseId = courseSelect.value;
        if (!courseId) {
            unitsContainer.innerHTML = '<p class="text-gray-500 col-span-full">โปรดเลือกรายวิชาก่อน</p>';
            return;
        }

        unitsContainer.innerHTML = '<p class="text-gray-500 col-span-full">กำลังโหลด...</p>';

        fetch(`${apiUrl}?course_id=${courseId}`)
            .then(response => response.json())
            .then(data => {
                unitsContainer.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(unit => {
                        const div = document.createElement('div');
                        div.classList.add('flex', 'items-center');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'learning_units';
                        checkbox.value = unit.id;
                        checkbox.id = `id_learning_units_${unit.id}`;
                        checkbox.classList.add('h-4', 'w-4', 'text-blue-600', 'border-gray-300', 'rounded');
                        const label = document.createElement('label');
                        label.htmlFor = `id_learning_units_${unit.id}`;
                        label.textContent = unit.unit_name;
                        label.classList.add('ml-3', 'text-sm', 'text-gray-700');
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        unitsContainer.appendChild(div);
                    });
                } else {
                    unitsContainer.innerHTML = '<p class="text-gray-500 col-span-full">ไม่พบหน่วยการเรียนรู้สำหรับรายวิชานี้</p>';
                }
            });
    }

    courseSelect.addEventListener('change', fetchLearningUnits);

    // Initial fetch if a course is already selected (e.g., on form error)
    if (courseSelect.value) {
        fetchLearningUnits();
    }
});
</script>
{% endblock %}